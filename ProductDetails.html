<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>View Listing | BizDirectory</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body {
      background-color: #f8f9fa;
    }

    .badge-trust {
      background-color: #e9ecef;
      color: #333;
    }
  </style>
</head>

<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">ToolBox</a>
      <a href="add-business.html" class="btn btn-danger">Add Your Business</a>
    </div>
  </nav>

  <!-- Page Content -->
  <div class="container py-5">

    <div class="row g-4">

      <!-- LEFT: Listing Details -->
      <div class="col-lg-8">

        <!-- Title -->
        <div class="mb-3">
          <h1 id="businessName" class="fw-bold">Loading...</h1>
          <span id="businessCategory" class="badge badge-trust me-2"></span>
          <span id="businessLocation" class="text-muted"></span>
          <div class="mb-4">
            <span id="businessStatus" class="badge bg-secondary">‚úî Admin Approved</span>
          </div>
        </div>

        <!-- Business Cover Image -->
        <div id="businessImageContainer" class="mb-4 rounded-4 overflow-hidden shadow-sm">
          <!-- Image will be loaded dynamically -->
        </div>

        <!-- Description -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h5 class="fw-bold mb-3">About Us</h5>
            <p id="businessDescription">Loading business information...</p>
          </div>
        </div>

        <!-- Products & Services -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h5 class="fw-bold mb-4">Products & Services</h5>
            <div id="productsList" class="row g-3">
              <!-- Products will be loaded dynamically -->
              <div class="col-12 text-center text-muted">
                <p>Loading products...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Reviews -->
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="fw-bold mb-3">Customer Reviews</h5>
            <div id="reviewsList">
              <!-- Reviews will be loaded dynamically -->
              <p class="text-muted">Loading reviews...</p>
            </div>
          </div>
        </div>
        <!-- Add Review -->
        <div class="card shadow-sm mt-4">
          <div class="card-body">
            <h5 class="fw-bold mb-3">
              <i class="bi bi-chat-left-text me-2"></i>
              Add a Review
            </h5>

            <!-- Login Notice -->
            <div class="alert alert-warning small d-flex align-items-start">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              <span>
                Reviews should be honest and based on real experiences.
              </span>
            </div>

            <form id="reviewForm">

              <!-- Rating -->
              <div class="mb-3">
                <label class="form-label fw-semibold">
                  <i class="bi bi-star-fill me-1 text-warning"></i>
                  Your Rating
                </label>
                <select id="reviewRating" class="form-select" required>
                  <option value="">Select rating</option>
                  <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ Excellent</option>
                  <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ Very Good</option>
                  <option value="3">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ Good</option>
                  <option value="2">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ Fair</option>
                  <option value="1">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ Poor</option>
                </select>
              </div>

              <!-- Review Text -->
              <div class="mb-3">
                <label class="form-label fw-semibold">
                  <i class="bi bi-pencil-square me-1"></i>
                  Your Review
                </label>
                <textarea id="reviewText" class="form-control" rows="4"
                  placeholder="Share your experience with this service or product..." required></textarea>
              </div>

              <!-- Reviewer Name -->
              <div class="mb-3">
                <label class="form-label fw-semibold">Your Name</label>
                <input type="text" id="reviewerName" class="form-control" placeholder="Your name" required>
              </div>

              <!-- Guidelines -->
              <p class="small text-muted">
                <i class="bi bi-shield-check me-1"></i>
                Do not include personal information, contact details, or offensive language.
                Fake or abusive reviews will be removed.
              </p>

              <!-- Submit -->
              <div class="d-grid">
                <button type="submit" class="btn btn-danger">
                  <i class="bi bi-send-fill me-1"></i>
                  Submit Review
                </button>
              </div>

            </form>
          </div>
        </div>

      </div>

      <!-- RIGHT: Contact & Safety -->
      <div class="col-lg-4">

        <!-- Contact Card -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h5 class="fw-bold mb-3">Contact Seller</h5>
            <p id="businessPhone" class="mb-1"></p>
            <p id="businessEmail" class="mb-1"></p>
            <p id="businessWebsite" class="mb-3"></p>

            <div class="d-grid">
              <button class="btn btn-danger">Contact Seller</button>
            </div>
          </div>
        </div>

        <!-- Safety Notice -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h6 class="fw-bold text-danger">Safety Tips</h6>
            <ul class="small mb-0">
              <li>Do not pay upfront without agreement</li>
              <li>Verify business details before payment</li>
              <li>Avoid sharing personal banking details</li>
            </ul>
          </div>
        </div>

        <!-- Report -->
        <div class="card shadow-sm">
          <div class="card-body text-center">
            <p class="small text-muted mb-2">
              Something not right?
            </p>
            <button class="btn btn-outline-danger btn-sm">
              üö© Report this listing
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Get business ID from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const businessId = urlParams.get('id');
    const API_URL = 'https://tool-api-3.onrender.com';

    if (!businessId) {
      alert('No business ID provided');
      window.location.href = 'index.html';
    } else {
      loadBusinessDetails();
      loadProducts();
      loadReviews();
    }

    async function loadBusinessDetails() {
      try {
        const response = await fetch(`${API_URL}/api/public/business/${businessId}`);
        const data = await response.json();

        if (data.success && data.business) {
          const biz = data.business;

          // Update business info
          document.getElementById('businessName').textContent = biz.name;
          document.getElementById('businessCategory').textContent = biz.category;
          document.getElementById('businessLocation').textContent = `üìç ${biz.city}, ${biz.province}`;
          document.getElementById('businessDescription').textContent = biz.description;

          // Update contact info
          document.getElementById('businessPhone').textContent = biz.phone ? `üìû ${biz.phone}` : '';
          document.getElementById('businessEmail').textContent = biz.email ? `üìß ${biz.email}` : '';
          document.getElementById('businessWebsite').textContent = biz.website ? `üåê ${biz.website}` : '';

          // Update cover image if available
          if (biz.logo && biz.logo.startsWith('data:')) {
            document.getElementById('businessImageContainer').innerHTML = `
              <img src="${biz.logo}" class="img-fluid w-100" alt="${biz.name}" style="height: 400px; object-fit: cover;">
            `;
          } else {
            document.getElementById('businessImageContainer').innerHTML = `
              <div class="bg-secondary d-flex align-items-center justify-content-center" style="height: 400px;">
                <h2 class="text-white">${biz.name}</h2>
              </div>
            `;
          }
        } else {
          alert('Business not found');
          window.location.href = 'index.html';
        }
      } catch (error) {
        console.error('Error loading business:', error);
        alert('Error loading business details');
      }
    }

    async function loadProducts() {
      const productsList = document.getElementById('productsList');

      try {
        const response = await fetch(`${API_URL}/api/public/products/${businessId}`);
        const data = await response.json();

        if (data.success && data.products.length > 0) {
          productsList.innerHTML = '';
          data.products.forEach(product => {
            const productCard = document.createElement('div');
            productCard.className = 'col-md-6';
            productCard.innerHTML = `
              <div class="d-flex align-items-center border rounded p-2">
                ${product.image && product.image.startsWith('data:') ?
                `<img src="${product.image}" class="rounded me-3" alt="${product.name}" style="width: 80px; height: 80px; object-fit: cover;">` :
                '<div class="bg-secondary rounded me-3" style="width: 80px; height: 80px;"></div>'
              }
                <div class="flex-grow-1">
                  <h6 class="fw-bold mb-1">${product.name}</h6>
                  <p class="text-muted small mb-1">${product.description || 'No description'}</p>
                  <span class="text-primary fw-bold">$${product.price.toFixed(2)}</span>
                </div>
              </div>
            `;
            productsList.appendChild(productCard);
          });
        } else {
          productsList.innerHTML = '<div class="col-12 text-center text-muted"><p>No products available yet.</p></div>';
        }
      } catch (error) {
        console.error('Error loading products:', error);
        productsList.innerHTML = '<div class="col-12 text-center text-danger"><p>Error loading products</p></div>';
      }
    }

    async function loadReviews() {
      const reviewsList = document.getElementById('reviewsList');

      try {
        const response = await fetch(`${API_URL}/api/public/reviews/${businessId}`);
        const data = await response.json();

        if (data.success && data.reviews.length > 0) {
          reviewsList.innerHTML = '';
          data.reviews.forEach((review, index) => {
            const stars = '‚≠ê'.repeat(review.rating);
            const reviewDiv = document.createElement('div');
            reviewDiv.className = index < data.reviews.length - 1 ? 'border-bottom pb-3 mb-3' : '';
            reviewDiv.innerHTML = `
              <strong>${stars} ${review.reviewerName}</strong>
              <p class="mb-1">${review.reviewText}</p>
            `;
            reviewsList.appendChild(reviewDiv);
          });
        } else {
          reviewsList.innerHTML = '<p class="text-muted">No reviews yet. Be the first to review!</p>';
        }
      } catch (error) {
        console.error('Error loading reviews:', error);
        reviewsList.innerHTML = '<p class="text-danger">Error loading reviews</p>';
      }
    }

    // Handle review submission
    document.getElementById('reviewForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const reviewData = {
        businessId: businessId,
        rating: document.getElementById('reviewRating').value,
        reviewText: document.getElementById('reviewText').value,
        reviewerName: document.getElementById('reviewerName').value
      };

      try {
        const response = await fetch(`${API_URL}/api/public/reviews`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(reviewData)
        });

        const result = await response.json();

        if (result.success) {
          alert('Review submitted successfully! It will be visible after moderation.');
          document.getElementById('reviewForm').reset();
          loadReviews(); // Reload reviews
        } else {
          alert(result.message || 'Error submitting review');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while submitting your review');
      }
    });
  </script>
</body>

</html>