<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>View Listing | BizDirectory</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body {
      background-color: #f8f9fa;
    }

    .badge-trust {
      background-color: #e9ecef;
      color: #333;
    }
  </style>
</head>

<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">ToolBox</a>
      <a href="add-business.html" class="btn btn-danger">Add Your Business</a>
    </div>
  </nav>

  <!-- Page Content -->
  <div class="container py-5">

    <div class="row g-4">

      <!-- LEFT: Listing Details -->
      <div class="col-lg-8">

        <!-- Title -->
        <div class="mb-3">
          <h1 id="businessName" class="fw-bold">Loading...</h1>
          <span id="businessCategory" class="badge badge-trust me-2"></span>
          <span id="businessLocation" class="text-muted"></span>
          <div class="mb-4">
            <span id="businessStatus" class="badge bg-secondary">‚úî Admin Approved</span>
          </div>
        </div>

        <!-- Business Cover Image -->
        <div id="businessImageContainer" class="mb-4 rounded-4 overflow-hidden shadow-sm">
          <!-- Image will be loaded dynamically -->
        </div>

        <!-- Description -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h5 class="fw-bold mb-3">About Us</h5>
            <p id="businessDescription">Loading business information...</p>
          </div>
        </div>

        <!-- Products & Services -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h5 class="fw-bold mb-4">Products & Services</h5>
            <div id="productsList" class="row g-3">
              <!-- Products will be loaded dynamically -->
              <div class="col-12 text-center text-muted">
                <p>Loading products...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Reviews -->
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="fw-bold mb-3">Customer Reviews</h5>
            <div id="reviewsList">
              <!-- Reviews will be loaded dynamically -->
              <p class="text-muted">Loading reviews...</p>
            </div>
          </div>
        </div>
        <!-- Add Review -->
        <div class="card shadow-sm mt-4">
          <div class="card-body">
            <h5 class="fw-bold mb-3">
              <i class="bi bi-chat-left-text me-2"></i>
              Add a Review
            </h5>

            <!-- Login Notice -->
            <div class="alert alert-warning small d-flex align-items-start">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              <span>
                Reviews should be honest and based on real experiences.
              </span>
            </div>

            <form id="reviewForm">

              <!-- Rating -->
              <div class="mb-3">
                <label class="form-label fw-semibold">
                  <i class="bi bi-star-fill me-1 text-warning"></i>
                  Your Rating
                </label>
                <select id="reviewRating" class="form-select" required>
                  <option value="">Select rating</option>
                  <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ Excellent</option>
                  <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ Very Good</option>
                  <option value="3">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ Good</option>
                  <option value="2">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ Fair</option>
                  <option value="1">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ Poor</option>
                </select>
              </div>

              <!-- Review Text -->
              <div class="mb-3">
                <label class="form-label fw-semibold">
                  <i class="bi bi-pencil-square me-1"></i>
                  Your Review
                </label>
                <textarea id="reviewText" class="form-control" rows="4"
                  placeholder="Share your experience with this service or product..." required></textarea>
              </div>

              <!-- Reviewer Name -->
              <div class="mb-3">
                <label class="form-label fw-semibold">Your Name</label>
                <input type="text" id="reviewerName" class="form-control" placeholder="Your name" required>
              </div>

              <!-- Guidelines -->
              <p class="small text-muted">
                <i class="bi bi-shield-check me-1"></i>
                Do not include personal information, contact details, or offensive language.
                Fake or abusive reviews will be removed.
              </p>

              <!-- Submit -->
              <div class="d-grid">
                <button type="submit" class="btn btn-danger">
                  <i class="bi bi-send-fill me-1"></i>
                  Submit Review
                </button>
              </div>

            </form>
          </div>
        </div>

      </div>

      <!-- RIGHT: Contact & Safety -->
      <div class="col-lg-4">

        <!-- Contact Card -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h5 class="fw-bold mb-3">Contact Seller</h5>
            <div id="contactDetails" class="mb-3">
              <p id="businessPhone" class="mb-2"><i class="bi bi-telephone-fill text-muted me-2"></i>Loading...</p>
              <p id="businessEmail" class="mb-2"><i class="bi bi-envelope-fill text-muted me-2"></i>Loading...</p>
              <p id="businessWebsite" class="mb-2"><i class="bi bi-globe text-muted me-2"></i>Loading...</p>
            </div>

            <div class="d-grid gap-2">
              <button id="contactBtn" class="btn btn-primary d-flex align-items-center justify-content-center">
                <i class="bi bi-chat-dots-fill me-2"></i> Contact Seller
              </button>
              <button id="whatsappBtn" class="btn btn-success d-flex align-items-center justify-content-center">
                <i class="bi bi-whatsapp me-2"></i> Chat on WhatsApp
              </button>
            </div>
          </div>
        </div>

        <!-- Business Hours -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h5 class="fw-bold mb-3 d-flex justify-content-between align-items-center">
              <span>Business Hours</span>
              <span id="currentStatusBadge" class="badge rounded-pill bg-light text-dark fs-6"
                style="font-size: 0.8rem;">Checking...</span>
            </h5>
            <div id="hoursList" class="small">
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Monday - Friday</span>
                <span id="hoursMonFri" class="fw-semibold">Closed</span>
              </div>
              <div class="d-flex justify-content-between">
                <span class="text-muted">Saturday - Sunday</span>
                <span id="hoursSatSun" class="fw-semibold">Closed</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Safety Notice -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h6 class="fw-bold text-danger">Safety Tips</h6>
            <ul class="small mb-0">
              <li>Do not pay upfront without agreement</li>
              <li>Verify business details before payment</li>
              <li>Avoid sharing personal banking details</li>
            </ul>
          </div>
        </div>

        <!-- Location & Map -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h5 class="fw-bold mb-3">
              <i class="bi bi-geo-alt-fill text-danger me-2"></i> Find Us
            </h5>
            <p id="fullAddress" class="text-muted mb-3"></p>
            <div id="mapContainer" class="rounded-3 overflow-hidden" style="height: 300px; background-color: #eee;">
              <!-- Map iframe will be loaded here -->
            </div>
            <div class="d-grid mt-3">
              <a id="getDirectionsBtn" href="#" target="_blank" class="btn btn-outline-secondary">
                <i class="bi bi-cursor-fill me-2"></i> Get Directions
              </a>
            </div>
          </div>
        </div>

        <!-- Report -->
        <div class="card shadow-sm">
          <div class="card-body text-center">
            <p class="small text-muted mb-2">
              Something not right?
            </p>
            <button class="btn btn-outline-danger btn-sm">
              üö© Report this listing
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Get business ID from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const businessId = urlParams.get('id');
    const API_URL = 'https://tool-api-3.onrender.com/'; // Use relative path

    if (!businessId) {
      alert('No business ID provided');
      window.location.href = 'index.html';
    } else {
      loadBusinessDetails();
      loadProducts();
      loadReviews();
    }

    async function loadBusinessDetails() {
      try {
        const response = await fetch(`${API_URL}api/public/business/${businessId}`);
        const data = await response.json();

        if (data.success && data.business) {
          const biz = data.business;

          // Update business info
          document.getElementById('businessName').textContent = biz.name;
          document.getElementById('businessCategory').textContent = biz.category;
          document.getElementById('businessLocation').textContent = `üìç ${biz.city}, ${biz.province}`;
          document.getElementById('businessDescription').textContent = biz.description;

          // Update contact info
          document.getElementById('businessPhone').innerHTML = biz.phone ? `<i class="bi bi-telephone-fill text-muted me-2"></i> ${biz.phone}` : '';
          document.getElementById('businessEmail').innerHTML = biz.email ? `<i class="bi bi-envelope-fill text-muted me-2"></i> ${biz.email}` : '';
          document.getElementById('businessWebsite').innerHTML = biz.website ? `<i class="bi bi-globe text-muted me-2"></i> <a href="${biz.website}" target="_blank" class="text-decoration-none">${biz.website.replace(/^https?:\/\//, '')}</a>` : '';

          // Update Location & Map
          const fullAddress = biz.address || `${biz.city}, ${biz.province}`;
          document.getElementById('fullAddress').innerHTML = `<i class="bi bi-geo-alt me-2"></i>${fullAddress}`;

          const mapQuery = encodeURIComponent(fullAddress);
          document.getElementById('mapContainer').innerHTML = `
            <iframe 
              width="100%" 
              height="300" 
              style="border:0" 
              loading="lazy" 
              allowfullscreen 
              referrerpolicy="no-referrer-when-downgrade"
              src="https://www.google.com/maps/embed/v1/place?key=REPLACE_WITH_API_KEY&q=${mapQuery}&zoom=15">
            </iframe>
          `.replace('REPLACE_WITH_API_KEY', ''); // We'll use a fallback if no key, but actually let's use a simpler one without key if possible or just a search link

          // Fallback to simple search embed if no key matches (Google requires a key for embed v1)
          // Let's use the standard "search" embed which is often free/easier or just a static image/link
          document.getElementById('mapContainer').innerHTML = `
            <iframe 
              width="100%" 
              height="300" 
              src="https://maps.google.com/maps?q=${mapQuery}&t=&z=15&ie=UTF8&iwloc=&output=embed" 
              frameborder="0" 
              scrolling="no" 
              marginheight="0" 
              marginwidth="0">
            </iframe>
          `;
          document.getElementById('getDirectionsBtn').href = `https://www.google.com/maps/dir/?api=1&destination=${mapQuery}`;

          // Update Business Hours
          if (biz.businessHours) {
            document.getElementById('hoursMonFri').textContent = biz.businessHours.week || 'Not Specified';
            document.getElementById('hoursSatSun').textContent = biz.businessHours.weekend || 'Not Specified';

            // Logic for Open/Closed status
            const now = new Date();
            const day = now.getDay(); // 0 (Sun) to 6 (Sat)
            const hoursStr = (day === 0 || day === 6) ? biz.businessHours.weekend : biz.businessHours.week;

            if (hoursStr && hoursStr.includes('-')) {
              try {
                const [openStr, closeStr] = hoursStr.split('-').map(s => s.trim());
                const openTime = new Date();
                const closeTime = new Date();

                const [openH, openM] = openStr.split(':').map(Number);
                const [closeH, closeM] = closeStr.split(':').map(Number);

                openTime.setHours(openH, openM, 0);
                closeTime.setHours(closeH, closeM, 0);

                const statusBadge = document.getElementById('currentStatusBadge');
                if (now >= openTime && now <= closeTime) {
                  statusBadge.className = 'badge rounded-pill bg-success text-white';
                  statusBadge.textContent = 'Open Now';
                } else {
                  statusBadge.className = 'badge rounded-pill bg-danger text-white';
                  statusBadge.textContent = 'Closed';
                }
              } catch (e) {
                document.getElementById('currentStatusBadge').textContent = 'Open';
              }
            } else {
              document.getElementById('currentStatusBadge').textContent = 'Open';
            }
          }

          // Setup WhatsApp button
          if (biz.phone) {
            document.getElementById('whatsappBtn').onclick = () => {
              const formattedPhone = biz.phone.replace(/\D/g, '');
              const message = encodeURIComponent(`Hi ${biz.name}, I saw your listing on ToolBox and I'm interested in your services!`);
              window.open(`https://wa.me/${formattedPhone}?text=${message}`, '_blank');
            };
          } else {
            document.getElementById('whatsappBtn').classList.add('d-none');
          }

          // Setup Contact button
          document.getElementById('contactBtn').onclick = () => {
            if (biz.email) window.location.href = `mailto:${biz.email}?subject=Inquiry from ToolBox`;
            else alert('Contact info not available');
          };

          // Update Status Badge
          const statusBadge = document.getElementById('businessStatus');
          if (biz.isFeatured) {
            statusBadge.className = 'badge bg-primary mb-2';
            statusBadge.innerHTML = '<i class="bi bi-star-fill me-1"></i> Featured Listing';
          } else {
            statusBadge.className = 'badge bg-success mb-2';
            statusBadge.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i> Verified Business';
          }

          // Update cover image if available
          if (biz.logo && biz.logo.startsWith('data:')) {
            document.getElementById('businessImageContainer').innerHTML = `
              <img src="${biz.logo}" class="img-fluid w-100" alt="${biz.name}" style="height: 400px; object-fit: cover;">
            `;
          } else {
            document.getElementById('businessImageContainer').innerHTML = `
              <div class="bg-primary text-white d-flex flex-column align-items-center justify-content-center" style="height: 400px; background: linear-gradient(45deg, #0d6efd, #0dcaf0);">
                <i class="bi bi-shop display-1 mb-3"></i>
                <h2 class="fw-bold">${biz.name}</h2>
              </div>
            `;
          }
        } else {
          alert('Business not found');
          window.location.href = 'index.html';
        }
      } catch (error) {
        console.error('Error loading business:', error);
        alert('Error loading business details');
      }
    }

    async function loadProducts() {
      const productsList = document.getElementById('productsList');

      try {
        const response = await fetch(`${API_URL}api/public/products/${businessId}`);
        const data = await response.json();

        if (data.success && data.products.length > 0) {
          productsList.innerHTML = '';
          data.products.forEach(product => {
            const productCard = document.createElement('div');
            productCard.className = 'col-md-6';
            productCard.innerHTML = `
              <div class="d-flex align-items-center border rounded p-2">
                ${product.image && product.image.startsWith('data:') ?
                `<img src="${product.image}" class="rounded me-3" alt="${product.name}" style="width: 80px; height: 80px; object-fit: cover;">` :
                '<div class="bg-secondary rounded me-3" style="width: 80px; height: 80px;"></div>'
              }
                <div class="flex-grow-1">
                  <h6 class="fw-bold mb-1">${product.name}</h6>
                  <p class="text-muted small mb-1">${product.description || 'No description'}</p>
                  <span class="text-primary fw-bold">$${product.price.toFixed(2)}</span>
                </div>
              </div>
            `;
            productsList.appendChild(productCard);
          });
        } else {
          productsList.innerHTML = '<div class="col-12 text-center text-muted"><p>No products available yet.</p></div>';
        }
      } catch (error) {
        console.error('Error loading products:', error);
        productsList.innerHTML = '<div class="col-12 text-center text-danger"><p>Error loading products</p></div>';
      }
    }

    async function loadReviews() {
      const reviewsList = document.getElementById('reviewsList');

      try {
        const response = await fetch(`${API_URL}api/public/reviews/${businessId}`);
        const data = await response.json();

        if (data.success && data.reviews.length > 0) {
          reviewsList.innerHTML = '';
          data.reviews.forEach((review, index) => {
            const stars = '‚≠ê'.repeat(review.rating);
            const reviewDiv = document.createElement('div');
            reviewDiv.className = index < data.reviews.length - 1 ? 'border-bottom pb-3 mb-3' : '';
            reviewDiv.innerHTML = `
              <strong>${stars} ${review.reviewerName}</strong>
              <p class="mb-1">${review.reviewText}</p>
            `;
            reviewsList.appendChild(reviewDiv);
          });
        } else {
          reviewsList.innerHTML = '<p class="text-muted">No reviews yet. Be the first to review!</p>';
        }
      } catch (error) {
        console.error('Error loading reviews:', error);
        reviewsList.innerHTML = '<p class="text-danger">Error loading reviews</p>';
      }
    }

    // Handle review submission
    document.getElementById('reviewForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const reviewData = {
        businessId: businessId,
        rating: document.getElementById('reviewRating').value,
        reviewText: document.getElementById('reviewText').value,
        reviewerName: document.getElementById('reviewerName').value
      };

      try {
        const response = await fetch(`${API_URL}api/public/reviews`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(reviewData)
        });

        const result = await response.json();

        if (result.success) {
          alert('Review submitted successfully! It will be visible after moderation.');
          document.getElementById('reviewForm').reset();
          loadReviews(); // Reload reviews
        } else {
          alert(result.message || 'Error submitting review');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while submitting your review');
      }
    });
  </script>
</body>

</html>